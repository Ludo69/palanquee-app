<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Palanqu√©es</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen px-4">

    <div class="w-full max-w-4xl p-6">
        <h1 class="text-3xl font-bold mb-4 text-center text-white">Gestion des Palanqu√©es</h1>

        <!-- Liste des Palanqu√©es (Grille en 2 colonnes) -->
        <div id="palanqueesContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

        <!-- Liste des plongeurs disponibles -->
        <h2 class="text-xl font-semibold mt-6 mb-2 text-white">Plongeurs Disponibles</h2>
        <div id="plongeursContainer" class="flex space-x-2 overflow-x-auto p-2 bg-gray-800 rounded-lg shadow-md">
            <% plongeurs.forEach(plongeur => { %>
                <div class="plongeur px-4 py-2 bg-gray-700 rounded-lg shadow text-sm font-semibold whitespace-nowrap cursor-pointer <%= (plongeur.niveau === 'N1' || plongeur.niveau === 'N2' || plongeur.niveau === 'N3') ? 'text-green-400' : 'text-blue-400' %>"
                     data-id="<%= plongeur.id %>" draggable="true">
                    <%= plongeur.nom %> - <%= plongeur.niveau %>
                </div>
            <% }) %>
        </div>

        <!-- Boutons d'action -->
        <div class="mt-6 flex justify-between">
            <button id="ajouterPalanquee" class="w-1/2 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg shadow-md transition duration-300">
                + Palanqu√©e
            </button>
            <button id="validerPalanquees" class="w-1/2 ml-2 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-lg shadow-md transition duration-300">
                ‚úÖ Valider
            </button>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="fixed bottom-0 left-0 w-full bg-gray-800 bg-opacity-80 backdrop-blur-md shadow-lg flex justify-around py-3 rounded-t-2xl">
        <a href="/" class="text-gray-400 hover:text-blue-400 flex flex-col items-center">
            <i class="fas fa-home text-xl"></i>
            <span class="text-xs">üè† Accueil</span>
        </a>
        <a href="/gestion-plongeurs" class="text-gray-400 hover:text-green-400 flex flex-col items-center">
            <i class="fas fa-users text-xl"></i>
            <span class="text-xs">üë§ Plongeurs</span>
        </a>
        <a href="/gestion-sorties" class="text-gray-400 hover:text-yellow-400 flex flex-col items-center">
            <i class="far fa-calendar-alt text-xl"></i>
            <span class="text-xs">ü§ø Sorties</span>
        </a>
        <a href="/selection-sorties" class="text-gray-400 hover:text-orange-400 flex flex-col items-center">
            <i class="fas fa-mask text-xl"></i>
            <span class="text-xs">üìã Palanqu√©es</span>
        </a>
    </div>

    <script>
        function getPlongeeIdFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get("id");
        }

        const PLONGEE_ID = getPlongeeIdFromURL();

        if (!PLONGEE_ID) {
            console.error("‚ö†Ô∏è Aucun ID de plong√©e trouv√© dans l'URL !");
        }

        document.addEventListener("DOMContentLoaded", function () {
            const palanqueesContainer = document.getElementById("palanqueesContainer");
            const plongeursContainer = document.getElementById("plongeursContainer");
            const ajouterPalanqueeBtn = document.getElementById("ajouterPalanquee");

            const animauxMarins = ["Pieuvre", "Dauphin", "Requin", "Tortue", "M√©duse", "Raie", "Corail"];
            let palanquees = [];

            function genererNomPalanquee() {
                return animauxMarins[Math.floor(Math.random() * animauxMarins.length)];
            }

            ajouterPalanqueeBtn.addEventListener("click", function () {
                const id = Date.now();
                const nom = genererNomPalanquee();
                palanquees.push({ id, nom, plongeurs: [] });
                afficherPalanquee(id, nom);
            });

            function rendrePlongeursDraggables() {
                console.log("üîÑ Fonction rendrePlongeursDraggables appel√©e !");
                
                document.querySelectorAll(".plongeur").forEach(plongeur => {
                    console.log("üéØ Plongeur d√©tect√© :", plongeur.dataset.id, "- draggable:", plongeur.draggable);
                    console.log("‚û°Ô∏è Plongeur d√©tect√© :", plongeur.dataset.id);
                    plongeur.setAttribute("draggable", "true"); // üî• Ajout√© pour forcer l'activation
                    
                    plongeur.addEventListener("dragstart", (event) => {
                        console.log("üöÄ Dragstart - Plongeur ID :", plongeur.dataset.id);
                        
                        event.dataTransfer.setData("text/plain", plongeur.dataset.id);
                        setTimeout(() => plongeur.classList.add("hidden"), 0);
                    });

                    plongeur.addEventListener("dragend", () => {
                        console.log("üõë Dragend - Plongeur r√©apparu :", plongeur.dataset.id);
                        plongeur.classList.remove("hidden");
                    });
                });
            }


                // V√©rifier si les plongeurs existent avant d'appliquer les √©v√©nements
            if (plongeursContainer.children.length > 0) {
                setTimeout(() => {
                    console.log("üìå V√©rification apr√®s d√©lai : ", document.querySelectorAll(".plongeur").length);
                    rendrePlongeursDraggables();
                }, 500);

            } else {
                console.log("‚è≥ En attente de chargement des plongeurs...");
                setTimeout(rendrePlongeursDraggables, 500);  // Petite attente pour recharger
            }

            function afficherPalanquee(id, nom) {
                const div = document.createElement("div");
                div.classList.add("bg-gray-800", "p-4", "rounded-lg", "shadow-md", "space-y-2");
                div.dataset.id = id;
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-semibold text-white">${nom}</span>
                        <button class="delete-palanquee text-red-500 hover:text-red-700 text-lg">‚ùå</button>
                    </div>
                    <div class="palanquee-body bg-gray-700 p-3 rounded-md min-h-[60px]" data-id="${id}"></div>
                `;

                const palanqueeBody = div.querySelector(".palanquee-body");

                // Suppression de la palanqu√©e
                div.querySelector(".delete-palanquee").addEventListener("click", function () {
                    supprimerPalanquee(id);
                });

                // Permettre le drag and drop
                palanqueeBody.addEventListener("dragover", (event) => {
                    event.preventDefault(); // Essentiel pour autoriser le d√©p√¥t !
                    event.dataTransfer.dropEffect = "move";
                });

                palanqueeBody.addEventListener("drop", (event) => {
                    event.preventDefault();
                    const plongeurId = event.dataTransfer.getData("text/plain");
                    const plongeur = document.querySelector(`[data-id='${plongeurId}']`);

                    console.log("üîπ D√©p√¥t d√©tect√© !");
                    console.log("üîπ Plongeur ID r√©cup√©r√© :", plongeurId);
                    console.log("üîπ √âl√©ment trouv√© :", plongeur);

                    if (plongeur) {
                        palanqueeBody.appendChild(plongeur);
                    }
                });

                palanqueesContainer.appendChild(div);
            }


            function supprimerPalanquee(id) {
                console.log("üóë Suppression de la palanqu√©e avec ID :", id);

                const palanqueeDiv = document.querySelector(`[data-id="${id}"]`);
                if (!palanqueeDiv) {
                    console.warn("‚ùå Palanqu√©e introuvable !");
                    return;
                }

                const palanqueeBody = palanqueeDiv.querySelector(".palanquee-body");

                // Remet tous les plongeurs dans la liste principale
                if (palanqueeBody) {
                    while (palanqueeBody.firstChild) {
                        console.log("‚Ü© Retour du plongeur :", palanqueeBody.firstChild.dataset.id);
                        plongeursContainer.appendChild(palanqueeBody.firstChild);
                    }
                }

                // Supprime la palanqu√©e
                palanqueeDiv.remove();
                console.log("‚úÖ Palanqu√©e supprim√©e avec succ√®s !");

                // Supprime la palanqu√©e du tableau en m√©moire
                palanquees = palanquees.filter(p => p.id !== id);

                // R√©active le drag & drop
                setTimeout(() => {
                    rendrePlongeursDraggables();
                }, 100);
            }





            plongeursContainer.addEventListener("dragover", (event) => {
                event.preventDefault();
                event.dataTransfer.dropEffect = "move";
            });

            plongeursContainer.addEventListener("drop", (event) => {
                event.preventDefault();
                const plongeurId = event.dataTransfer.getData("text/plain");
                const plongeur = document.querySelector(`[data-id='${plongeurId}']`);
                if (plongeur) {
                    plongeursContainer.appendChild(plongeur);
                }
            });
        });

        document.getElementById("validerPalanquees").addEventListener("click", async () => {
            if (!PLONGEE_ID) {
                alert("Erreur : Impossible de r√©cup√©rer l'ID de la plong√©e !");
                return;
            }

            const palanqueesData = [];

            document.querySelectorAll(".palanquee-body").forEach(palanquee => {
                const id = palanquee.dataset.id;
                const nomElement = palanquee.closest(".bg-gray-800")?.querySelector("span");
                const nom = nomElement ? nomElement.textContent : "Nom inconnu";
                const plongeurs = [...palanquee.querySelectorAll("[data-id]")].map(p => p.dataset.id);

                if (plongeurs.length > 0) {
                    palanqueesData.push({ id, nom, plongeurs });
                }
            });

            if (palanqueesData.length === 0) {
                alert("Aucune palanqu√©e √† enregistrer !");
                return;
            }

            try {
                const palanqueesDataFormatted = palanqueesData.map(palanquee => ({
                    plongee_id: PLONGEE_ID,
                    nom: palanquee.nom,
                    profondeur: 0,
                    duree: 0,
                    paliers: "",
                    plongeurs: palanquee.plongeurs
                }));

                const response = await fetch("/enregistrer_palanquee", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(palanqueesDataFormatted)
                });

                const result = await response.json();

                if (response.ok) {
                    alert("Palanqu√©es enregistr√©es avec succ√®s !");
                    document.getElementById("palanqueesContainer").innerHTML = "";
                } else {
                    alert("‚ùå Erreur : " + result.error);
                }
            } catch (error) {
                console.error("‚ùå Erreur lors de l'enregistrement :", error);
            }
        });

    </script>

</body>
</html>

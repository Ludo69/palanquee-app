<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Plong√©es</title>
    <link rel="stylesheet" href="/styles.css"> <!-- V√©rifie que le fichier CSS est bien accessible -->
</head>
<body>
    <div class="container">
        <button class="btn-retour" onclick="history.back()">Retour</button>
        <h1 class="title">Plong√©e du <span id="selected-date"><%= date %></span></h1>

        <ul class="plongees-list" id="plongeesList">
            <% if (plongees && plongees.length > 0) { %>
                <% plongees.forEach(function(plongee) { %>
                    <li class="plongee-item" data-id="<%= plongee.id %>">
                        <span>Plong√©e <%= plongee.numero %> - <span class="site-name"><%= plongee.site || "Nom du site" %></span></span>
                        <button class="edit-btn">Site</button>
                        <a href="/parametres_palanquees?id=<%= plongee.id %>" class="parametres-link">
                            <img src="/icons/liste.png" alt="Param√®tres" class="parametres-icon">
                        </a>
                    </li>
                    
                                       
                <% }); %>
            <% } else { %>
                <p id="no-plongees-message">Aucune plong√©e √† afficher.</p>
            <% } %>
        </ul>

        <!-- Bouton Ajouter Plong√©e en bas -->
        <div class="form-container">
            <button class="add-button" id="ajouter-plongee">Ajouter Plong√©e</button>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            console.log("‚úÖ Script charg√©");

            // Redirection vers gestion_palanquees.ejs lorsqu'on clique sur une plong√©e
            document.querySelectorAll(".plongee-item").forEach(item => {
                item.addEventListener("click", function (event) {
                    // V√©rifie si l'utilisateur clique sur le bouton "√âditer", dans ce cas on ne redirige pas
                    if (event.target.classList.contains("edit-btn")) return;

                    const plongeeId = this.getAttribute("data-id");
                    if (plongeeId) {
                        window.location.href = `/gestion_palanquees?id=${plongeeId}`;
                    }
                });
            });

            document.querySelectorAll(".edit-btn").forEach(button => {
                button.addEventListener("click", function () {
                    console.log("‚úèÔ∏è Bouton '√âditer' cliqu√©");

                    const plongeeItem = this.closest(".plongee-item");
                    if (!plongeeItem) {
                        console.error("‚ùå Erreur : Impossible de trouver .plongee-item");
                        return;
                    }

                    let siteNameSpan = plongeeItem.querySelector(".site-name");

                    // V√©rifier si le site existe d√©j√†
                    if (!siteNameSpan) {
                        console.log("‚ö†Ô∏è Aucune donn√©e de site trouv√©e, cr√©ation d'un √©l√©ment vide.");
                        siteNameSpan = document.createElement("span");
                        siteNameSpan.classList.add("site-name");
                        siteNameSpan.textContent = "Aucun site";
                        plongeeItem.appendChild(siteNameSpan);
                    }

                    console.log("üìå √âl√©ment √† modifier:", siteNameSpan.textContent);

                    // Cr√©er un champ input et un bouton de validation
                    const input = document.createElement("input");
                    input.type = "text";
                    input.value = siteNameSpan.textContent !== "Aucun site" ? siteNameSpan.textContent : "";
                    input.classList.add("edit-site-input");

                    const saveButton = document.createElement("button");
                    saveButton.textContent = "‚úÖ";
                    saveButton.classList.add("save-btn");

                    // Remplace le texte par l'input
                    siteNameSpan.replaceWith(input);
                    plongeeItem.appendChild(saveButton);

                    // Ajouter l'√©v√©nement click au bouton valider
                    saveButton.addEventListener("click", async function () {
                        console.log("üü¢ Bouton 'Valider' cliqu√©");

                        const newSiteName = input.value.trim();
                        const plongeeId = plongeeItem.getAttribute("data-id");

                        if (!newSiteName) {
                            alert("Le nom du site ne peut pas √™tre vide !");
                            return;
                        }

                        console.log(`üîÑ Mise √† jour du site : ${newSiteName} (Plong√©e ID: ${plongeeId})`);

                        try {
                            const response = await fetch("/api/mettre-a-jour-site", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ id: plongeeId, site: newSiteName })
                            });

                            if (!response.ok) {
                                throw new Error(`Erreur serveur (${response.status}): ${await response.text()}`);
                            }

                            console.log("‚úÖ Mise √† jour r√©ussie");

                            // Cr√©er un nouveau span mis √† jour
                            const updatedSiteSpan = document.createElement("span");
                            updatedSiteSpan.classList.add("site-name");
                            updatedSiteSpan.textContent = newSiteName;

                            input.replaceWith(updatedSiteSpan);
                            saveButton.remove();

                        } catch (error) {
                            console.error("üö® Erreur lors de la mise √† jour :", error);
                            alert("Erreur lors de la mise √† jour du site.");
                        }
                    });
                });
            });
        });
    </script>

</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <h1 class="text-3xl font-bold mb-4 text-center text-white">Param√®tres</h1>
    <link rel="stylesheet" href="/styles.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <!-- Bouton de retour en haut √† gauche -->
    <button onclick="window.history.back()" class="absolute top-4 left-4 text-white hover:text-gray-300 text-2xl">
        ‚Üê
    </button>
    <!-- Bouton Retour -->
    <!--<button onclick="retour()" class="fixed top-4 left-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-blue-600 transition duration-300">
        Retour
    </button>-->
    <div class="container">
        <!-- Ic√¥ne WhatsApp -->
    <a href="javascript:void(0);" class="btn-whatsapp" onclick="envoyerParWhatsApp()">
        <img src="https://upload.wikimedia.org/wikipedia/commons/5/5e/WhatsApp_icon.png" alt="Partager sur WhatsApp">
    </a>

    <!-- Ic√¥ne PDF -->
    <button onclick="sendWhatsApp()" class="btn-pdf">
        <img src="\icons\iconPDF.png" alt="PDF Icon" class="icon-pdf" />
    </button>


        <% if (palanquees && palanquees.length > 0) { %>
            <% palanquees.forEach(function(palanquee) { %>
                <div class="palanquee-container">
                    <!-- üü¢ Partie Gauche -->
                    <div class="palanquee-left">
                        <h2 class="palanquee-nom"><%= palanquee.nom %></h2>
                        <p><strong>Plongeurs :</strong></p>
                        <ul class="plongeurs-list flex flex-col gap-1">
                            <% if (palanquee.plongeurs && palanquee.plongeurs.length > 0) { 
                                // Trier les plongeurs pour que ceux avec la classe bleue (non guide) soient en haut
                                palanquee.plongeurs.sort(function(a, b) {
                                    const aEstBleu = !["N1", "N2", "N3"].includes(a.niveau_plongeur_historique); // Bleu si pas un guide
                                    const bEstBleu = !["N1", "N2", "N3"].includes(b.niveau_plongeur_historique); // Bleu si pas un guide
                                    
                                    // Si A est bleu et B ne l'est pas, A doit √™tre avant B
                                    if (aEstBleu && !bEstBleu) return -1;
                                    // Si B est bleu et A ne l'est pas, B doit √™tre avant A
                                    if (!aEstBleu && bEstBleu) return 1;
                                    // Si les deux ont la m√™me classe (les deux sont bleus ou les deux sont verts), on garde leur ordre
                                    return 0;
                                });
                            %>
                                <% palanquee.plongeurs.forEach(function(plongeur) { 
                                    let couleurClasse = (["N1", "N2", "N3"].includes(plongeur.niveau_plongeur_historique)) ? "text-green-500" : "text-blue-500"; 
                                %>
                                    <li class="<%= couleurClasse %> font-semibold">
                                        <%= plongeur.nom %> -  
                                        <%= plongeur.niveau_plongeur_historique ? plongeur.niveau_plongeur_historique : "N/A" %>
                                    </li>
                                <% }); %>
                            <% } else { %>
                                <li class="text-gray-500 italic">Aucun plongeur dans cette palanqu√©e.</li>
                            <% } %>
                        </ul>
                    </div>
                    
                
                    <!-- üîµ Partie Droite -->
                    <div class="palanquee-right">
                        <form id="form-<%= palanquee.id %>" class="palanquee-form">
                            <input type="hidden" name="palanquee_id" value="<%= palanquee.id %>">
                            
                            <label>Profondeur (m) :</label>
                            <input type="number" name="profondeur" class="profondeur" value="<%= palanquee.profondeur || '' %>" 
                                <%= palanquee.profondeur ? 'disabled' : '' %> required>
                        
                            <label>Dur√©e (min) :</label>
                            <input type="number" name="duree" class="duree" value="<%= palanquee.duree || '' %>" 
                                <%= palanquee.duree ? 'disabled' : '' %> required>                
                        
                            <label>Paliers :</label>
                            <input type="text" name="paliers" class="paliers" value="<%= palanquee.paliers || '' %>" 
                                <%= palanquee.paliers ? 'disabled' : '' %> required>
                            
                            <!-- ‚úÖ Checkbox align√©e -->
                            <div class="inline-flex items-center space-x-1">
                                <input type="checkbox" id="paliers-<%= palanquee.id %>-checkbox" class="paliers-checkbox">
                                <label for="paliers-<%= palanquee.id %>-checkbox" class="whitespace-nowrap text-sm m-0 p-0">3m / 3m S√©cu</label>
                            </div>                                                       
                                                                                           
                        </form>
                    </div>
                
                    <!-- üîª Partie Bas (Nouveau Conteneur pour le bouton) -->
                    <div class="palanquee-bas w-full flex justify-center mt-4">
                        <button type="submit" class="btn-enregistrer" data-form-id="form-<%= palanquee.id %>"
                            <%= (palanquee.duree !== null && palanquee.duree !== '' &&
                                palanquee.profondeur !== null && palanquee.profondeur !== '' &&
                                palanquee.paliers !== null && palanquee.paliers !== '') ? 'disabled' : '' %>>
                            Enregistrer
                        </button>
                    </div>
                    

                </div>
                
            <% }); %>
        <% } else { %>
            <p>Aucune palanqu√©e disponible pour cette plong√©e.</p>
        <% } %>
        

        <!-- Bottom Navigation -->
        <div class="fixed bottom-0 left-0 w-full bg-gray-800 bg-opacity-80 backdrop-blur-md shadow-lg flex justify-around py-3 rounded-t-2xl">
            <a href="/" class="text-gray-400 hover:text-blue-400 flex flex-col items-center">
                <i class="fas fa-home text-xl"></i>
                <span class="text-xs">üè† Accueil</span>
            </a>
            <a href="/gestion-plongeurs" class="text-gray-400 hover:text-green-400 flex flex-col items-center">
                <i class="fas fa-users text-xl"></i>
                <span class="text-xs">üë§ Plongeurs</span>
            </a>
            <a href="/gestion-sorties" class="text-gray-400 hover:text-yellow-400 flex flex-col items-center">
                <i class="far fa-calendar-alt text-xl"></i>
                <span class="text-xs">ü§ø Sorties</span>
            </a>
            <a href="/selection-sorties" class="text-gray-400 hover:text-orange-400 flex flex-col items-center">
                <i class="fas fa-mask text-xl"></i>
                <span class="text-xs">üìã Palanqu√©es</span>
            </a>
        </div>

    
    <script>
    // Fonction pour revenir √† l'√©cran pr√©c√©dent
    function retour() {
        history.back(); // Revenir √† la page pr√©c√©dente
    }

    const urlParams = new URLSearchParams(window.location.search);
    const plongeeId = urlParams.get("id"); // R√©cup√®re l'ID de la plong√©e depuis l'URL
    console.log("üîç ID de la plong√©e r√©cup√©r√© :", plongeeId);

    document.querySelectorAll(".btn-enregistrer").forEach(button => {
    button.addEventListener("click", async function (event) {
        event.preventDefault(); // Emp√™che le rechargement de la page
        this.disabled = true; // D√©sactive imm√©diatement le bouton pour √©viter un double clic

        // Trouver le formulaire en utilisant data-form-id
        const form = document.querySelector(`#${this.getAttribute("data-form-id")}`);
        if (!form) {
            console.error("‚ùå Erreur : Le formulaire sp√©cifi√© par data-form-id n'a pas √©t√© trouv√©.");
            alert("‚ùå Impossible d'enregistrer : formulaire non trouv√©.");
            this.disabled = false;
            return;
        }

        // R√©cup√©rer l'ID de la palanqu√©e √† partir de l'input name="palanquee_id"
        const palanqueeIdInput = form.querySelector("[name='palanquee_id']");
        if (!palanqueeIdInput) {
            console.error("‚ùå Erreur : Champ palanquee_id introuvable dans le formulaire.");
            alert("‚ùå Impossible d'enregistrer : ID de la palanqu√©e introuvable.");
            this.disabled = false;
            return;
        }

        const palanqueeId = palanqueeIdInput.value;
        console.log("‚úÖ ID de la palanqu√©e r√©cup√©r√© :", palanqueeId);

        if (!palanqueeId) {
            console.error("‚ùå Erreur : ID de palanqu√©e manquant !");
            alert("‚ùå Impossible d'enregistrer : ID de la palanqu√©e manquant.");
            this.disabled = false;
            return;
        }

        // V√©rifier si le formulaire existe
        const formElement = document.querySelector(`#form-${palanqueeId}`);
        console.log("Formulaire trouv√© :", formElement);

        if (!formElement) {
            console.error(`‚ùå Erreur : Formulaire pour la palanqu√©e ${palanqueeId} introuvable !`);
            alert(`‚ùå Erreur interne : formulaire #form-${palanqueeId} non trouv√©.`);
            this.disabled = false;
            return;
        }

        // R√©cup√©ration s√©curis√©e des champs
        const dureeInput = formElement.querySelector(".duree");
        const profondeurInput = formElement.querySelector(".profondeur");
        const paliersInput = formElement.querySelector(".paliers");

        if (!dureeInput || !profondeurInput || !paliersInput) {
            console.error("‚ùå Erreur : Un ou plusieurs champs sont introuvables !");
            alert("‚ùå Erreur interne : champs de saisie non trouv√©s.");
            this.disabled = false;
            return;
        }

        const duree = dureeInput.value;
        const profondeur = profondeurInput.value;
        const paliers = paliersInput.value;

        try {
            const response = await fetch("/sauvegarder_parametres", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: palanqueeId, duree, profondeur, paliers })
            });

            if (!response.ok) throw new Error("Erreur serveur");

            const result = await response.json();
            if (result.success) {
                alert("‚úÖ Param√®tres enregistr√©s avec succ√®s !");
                dureeInput.disabled = true;
                profondeurInput.disabled = true;
                paliersInput.disabled = true;
            } else {
                alert("‚ùå Erreur lors de l'enregistrement.");
                this.disabled = false;
            }
        } catch (error) {
            console.error("üö® Erreur lors de la requ√™te ::", error);
            alert("‚ùå Erreur de communication avec le serveur.");
            this.disabled = false;
        }
    });
});



// Initialisation de la valeur "Aucun" dans le champ paliers au chargement de la page
document.querySelectorAll(".palanquee-form").forEach(form => {
    const paliersInput = form.querySelector(".paliers");
    if (paliersInput && !paliersInput.value) {
        paliersInput.value = 'Aucun'; // Valeur par d√©faut "Aucun" au chargement de la page
    }
});

// Gestion de la case √† cocher pour les paliers
document.querySelectorAll(".paliers-checkbox").forEach(checkbox => {
    checkbox.addEventListener("change", function() {
        const palanqueeId = this.id.replace("paliers-", "").replace("-checkbox", "");
        console.log("‚úÖ ID extrait :", palanqueeId);

        const form = document.querySelector(`#form-${palanqueeId}`);
        if (!form) {
            console.error(`‚ùå ERREUR : Aucun formulaire trouv√© avec l'ID #form-${palanqueeId}`);
            return;
        }

        const paliersInput = form.querySelector(".paliers");
        console.log("üîç √âl√©ment paliersInput trouv√© :", paliersInput);

        if (!paliersInput) {
            console.error(`‚ùå ERREUR : Aucun champ paliers trouv√© dans #form-${palanqueeId}`);
            return;
        }

        // Si la case "3m / 3m S√©cu" est coch√©e
        if (this.checked && this.id.includes('checkbox')) {
            paliersInput.value = '3m / 3m S√©cu'; // Mettre "3m / 3m S√©cu" dans le champ
        } else {
            // Si aucune case n'est coch√©e, on met "Aucun" comme valeur par d√©faut
            const anyChecked = form.querySelectorAll(".paliers-checkbox:checked").length > 0;
            if (!anyChecked) {
                paliersInput.value = 'Aucun'; // "Aucun" est d√©fini si aucune case n'est coch√©e
            }
        }
    });
});






    async function envoyerParWhatsApp() {
        const plongeeId = "<%= typeof plongeeId !== 'undefined' ? plongeeId : '' %>";

        try {
            const response = await fetch(`/plongee_info?id=${plongeeId}`);
            const data = await response.json();

            if (data.error) {
                alert("Erreur : " + data.error);
                return;
            }

            console.log("üìÖ Date brute r√©cup√©r√©e :", data.date);

            let datePlongee = data.date;
            if (!datePlongee || datePlongee.toLowerCase().includes("invalid")) {
                console.error("‚ùå Erreur : Date invalide ->", data.date);
                datePlongee = "Date inconnue";
            }

            let nomSitePlongee = data.site || "Site inconnu"; 

            let message = `üåä *Compte-rendu Plong√©e* üåä\n`;
            message += `üìÖ *Date* : ${datePlongee}\n`;
            message += `ü§ø *Plong√©e n¬∞1 - ${nomSitePlongee}*\n\n`;

            <% palanquees.forEach(function(palanquee) { %>
                message += `üîπ *Palanqu√©e <%= palanquee.nom %>*\n`;
                message += `üìè *Profondeur* : <%= palanquee.profondeur || 'Non d√©fini' %> m\n`;
                message += `‚è≥ *Dur√©e* : <%= palanquee.duree || 'Non d√©fini' %> min\n`;
                message += `‚öì *Paliers* : <%= palanquee.paliers || 'Non d√©finis' %>\n`;
                message += `üë• *Plongeurs* :\n`;

                <% if (palanquee.plongeurs && palanquee.plongeurs.length > 0) { %>
                    <% palanquee.plongeurs.forEach(function(plongeur) { %>
                        message += `   - <%= plongeur.nom %> (<%= plongeur.niveau_plongeur_historique %>)\n`;
                    <% }); %>
                <% } else { %>
                    message += `   Aucun plongeur dans cette palanqu√©e.\n`;
                <% } %>

                message += "\n"; // Ligne vide pour s√©parer
            <% }); %>

            let url = "https://wa.me/?text=" + encodeURIComponent(message);
            window.location.href = url; // Redirection directe au lieu d'une pop-up
        } catch (error) {
            console.error("‚ùå Erreur r√©cup√©ration plong√©e:", error);
            alert("Impossible de r√©cup√©rer les informations de la plong√©e.");
        }
    }

    async function sendWhatsApp() {
    const plongeeId = "<%= typeof plongeeId !== 'undefined' ? plongeeId : '' %>";

    if (!plongeeId) {
        console.error("‚ùå Erreur : plongeeId est requis !");
        alert("ID de plong√©e requis");
        return;
    }

    try {
        console.log("üì° Envoi de la requ√™te pour g√©n√©rer le PDF...");

        // Appeler l'API qui g√©n√®re le PDF avec l'ID de la plong√©e
        const response = await fetch(`/generate-pdf?plongeeId=${plongeeId}`);
        
        // V√©rifier la r√©ponse de l'API
        if (!response.ok) {
            throw new Error(`Erreur lors de la g√©n√©ration du PDF (${response.status})`);
        }

        const data = await response.json();
        const pdfUrl = window.location.origin + data.url;

        // V√©rifiez si l'URL du PDF est valide
        if (!pdfUrl) {
            console.error("‚ùå PDF URL est invalide ou vide");
            alert("Le PDF n'a pas pu √™tre g√©n√©r√©");
            return;
        }

        console.log("‚úÖ PDF g√©n√©r√© avec succ√®s !");

        // Construire le message WhatsApp avec le lien du PDF
        const message = encodeURIComponent(`üìÑ Voici les param√®tres de la plong√©e : ${pdfUrl}`);
        const whatsappUrl = `https://wa.me/?text=${message}`;

        // Rediriger vers WhatsApp
        window.location.href = whatsappUrl;  // Utilisation de redirection directe
    } catch (error) {
        console.error("‚ùå Erreur lors de la g√©n√©ration du PDF :", error);
        alert("Erreur lors de la g√©n√©ration du PDF. Veuillez r√©essayer.");
    }
}


</script>


    <!-- IndexedDB and App Scripts -->
    <script src="/js/indexeddb.js"></script>
    <script src="/js/client.js"></script>
</body>
</html>

<style>
    /* Conteneur principal */
.palanquee-container {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    background-color: #1b263b;
    border-radius: 10px;
    padding: 20px;
    width: 90%;
    max-width: 600px;
    min-height: 180px;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.3);
    margin: 15px auto;
    flex-wrap: wrap;
    position: relative; /* Permet un centrage absolu du bouton */
}

/* Colonne gauche */
.palanquee-left {
    width: 50%;
    text-align: left;
}

/* Colonne droite */
.palanquee-right {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
    width: 50%;
}

/* Labels */
.palanquee-right label {
    display: block;
    font-size: 14px;
    color: white;
    margin-top: 5px;
}

/* Champs de saisie */
.palanquee-right input {
    width: 80%;
    padding: 5px;
    margin-top: 3px;
    border-radius: 5px;
    border: none;
    font-size: 14px;
    background-color: white;
    color: black;
}

/* Conteneur du bouton pour le centrer */
.btn-container {
    width: 100%;
    display: flex;
    justify-content: center; /* üîπ Centre le bouton */
    position: absolute;
    bottom: 20px; /* üîπ Ajuste la position en bas */
}

/* Bouton Enregistrer */
.btn-enregistrer {
    padding: 10px 20px;
    background-color: #28a745; /* ‚úÖ Vert */
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    text-align: center;
    font-size: 14px;
    font-weight: bold;
}

.btn-enregistrer:disabled {
    background-color: gray;
    cursor: not-allowed;
}

    </style>
    
    

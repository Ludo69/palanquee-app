<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Param√®tres des Palanqu√©es</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container">
        <button class="btn-retour" onclick="history.back()">Retour</button>
        <button class="btn-whatsapp" onclick="envoyerParWhatsApp()">üì© Envoyer par WhatsApp</button>

        <h1 class="title">Listing des palanqu√©es</h1>

        <% if (palanquees && palanquees.length > 0) { %>
            <% palanquees.forEach(function(palanquee) { %>
                <div class="palanquee-container">
                    <div class="palanquee-left">
                        <h2 class="palanquee-nom"><%= palanquee.nom %></h2>
                        <p><strong>Plongeurs :</strong></p>
                        <ul class="plongeurs-list">
                            <% if (palanquee.plongeurs && palanquee.plongeurs.length > 0) { %>
                                <% palanquee.plongeurs.forEach(function(plongeur) { %>
                                    <li class="plongeur-item"><%= plongeur.nom %> (<%= plongeur.niveau %>)</li>
                                <% }); %>
                            <% } else { %>
                                <li>Aucun plongeur dans cette palanqu√©e.</li>
                            <% } %>
                        </ul>
                    </div>

                    <div class="palanquee-right">
                        <form id="form-<%= palanquee.id %>" class="palanquee-form">
                            <input type="hidden" name="palanquee_id" value="<%= palanquee.id %>">
                            <label>Profondeur (m) :</label>
                            <input type="number" name="profondeur" class="profondeur" value="<%= palanquee.profondeur || '' %>" 
                                <%= palanquee.profondeur ? 'disabled' : '' %> required>

                            <label>Dur√©e (min) :</label>
                            <input type="number" name="duree" class="duree" value="<%= palanquee.duree || '' %>" 
                                <%= palanquee.duree ? 'disabled' : '' %> required>                
                        
                            <label>Paliers :</label>
                            <input type="text" name="paliers" class="paliers" value="<%= palanquee.paliers || '' %>" 
                                <%= palanquee.paliers ? 'disabled' : '' %> required>
                        
                            <button type="submit" class="btn-enregistrer"
                                <%= (palanquee.duree !== null && palanquee.duree !== '' &&
                                     palanquee.profondeur !== null && palanquee.profondeur !== '' &&
                                     palanquee.paliers !== null && palanquee.paliers !== '') ? 'disabled' : '' %>>
                                Enregistrer
                            </button>
                            
                        </form>
                        
                        
                        
                    </div>
                </div>
            <% }); %>
        <% } else { %>
            <p>Aucune palanqu√©e disponible pour cette plong√©e.</p>
        <% } %>
    </div>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const plongeeId = urlParams.get("id"); // R√©cup√®re l'ID de la plong√©e depuis l'URL
        console.log("üîç ID de la plong√©e r√©cup√©r√© :", plongeeId);

        document.querySelectorAll(".btn-enregistrer").forEach(button => {
    button.addEventListener("click", async function (event) {
        event.preventDefault(); // Emp√™che le rechargement de la page
        this.disabled = true; // üîπ D√©sactive imm√©diatement le bouton pour √©viter un double clic

        const palanqueeId = this.closest("form").querySelector("[name='palanquee_id']").value;
        if (!palanqueeId) {
            console.error("‚ùå Erreur : ID de palanqu√©e manquant !");
            alert("‚ùå Impossible d'enregistrer : ID de la palanqu√©e manquant.");
            this.disabled = false;
            return;
        }

        const form = document.querySelector(`#form-${palanqueeId}`);
        if (!form) {
            console.error("‚ùå Erreur : Formulaire introuvable !");
            alert("‚ùå Erreur interne : formulaire non trouv√©.");
            this.disabled = false;
            return;
        }

        // R√©cup√©ration s√©curis√©e des champs
        const dureeInput = form.querySelector(".duree");
        const profondeurInput = form.querySelector(".profondeur");
        const paliersInput = form.querySelector(".paliers");

        if (!dureeInput || !profondeurInput || !paliersInput) {
            console.error("‚ùå Erreur : Un ou plusieurs champs sont introuvables !");
            alert("‚ùå Erreur interne : champs de saisie non trouv√©s.");
            this.disabled = false;
            return;
        }

        const duree = dureeInput.value;
        const profondeur = profondeurInput.value;
        const paliers = paliersInput.value;

        try {
            const response = await fetch("/sauvegarder_parametres", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: palanqueeId, duree, profondeur, paliers })
            });

            if (!response.ok) throw new Error("Erreur serveur");

            const result = await response.json();
            if (result.success) {
                alert("‚úÖ Param√®tres enregistr√©s avec succ√®s !");
                dureeInput.disabled = true;
                profondeurInput.disabled = true;
                paliersInput.disabled = true;
            } else {
                alert("‚ùå Erreur lors de l'enregistrement.");
                this.disabled = false;
            }
        } catch (error) {
            console.error("üö® Erreur lors de la requ√™te :", error);
            alert("‚ùå Erreur de communication avec le serveur.");
            this.disabled = false;
        }
    });
});


        </script>
        <script>
            async function envoyerParWhatsApp() {
                const plongeeId = "<%= typeof plongeeId !== 'undefined' ? plongeeId : '' %>";
        
                try {
                    const response = await fetch(`/plongee_info?id=${plongeeId}`);
                    const data = await response.json();
        
                    if (data.error) {
                        alert("Erreur : " + data.error);
                        return;
                    }
        
                    console.log("üìÖ Date brute r√©cup√©r√©e :", data.date);
        
                    let datePlongee = data.date;
                    if (!datePlongee || datePlongee.toLowerCase().includes("invalid")) {
                        console.error("‚ùå Erreur : Date invalide ->", data.date);
                        datePlongee = "Date inconnue";
                    }
        
                    let nomSitePlongee = data.site || "Site inconnu"; 
        
                    let message = `üåä *Compte-rendu Plong√©e* üåä\n`;
                    message += `üìÖ *Date* : ${datePlongee}\n`;
                    message += `ü§ø *Plong√©e n¬∞1 - ${nomSitePlongee}*\n\n`;
        
                    <% palanquees.forEach(function(palanquee) { %>
                        message += `üîπ *Palanqu√©e <%= palanquee.nom %>*\n`;
                        message += `‚è≥ *Dur√©e* : <%= palanquee.duree || 'Non d√©fini' %> min\n`;
                        message += `üìè *Profondeur* : <%= palanquee.profondeur || 'Non d√©fini' %> m\n`;
                        message += `‚öì *Paliers* : <%= palanquee.paliers || 'Non d√©finis' %>\n`;
                        message += `üë• *Plongeurs* :\n`;
        
                        <% if (palanquee.plongeurs && palanquee.plongeurs.length > 0) { %>
                            <% palanquee.plongeurs.forEach(function(plongeur) { %>
                                message += `   - <%= plongeur.nom %> (<%= plongeur.niveau %>)\n`;
                            <% }); %>
                        <% } else { %>
                            message += `   Aucun plongeur dans cette palanqu√©e.\n`;
                        <% } %>
        
                        message += "\n"; // Ligne vide pour s√©parer
                    <% }); %>
        
                    let url = "https://wa.me/?text=" + encodeURIComponent(message);
                    window.open(url, "_blank");
                } catch (error) {
                    console.error("‚ùå Erreur r√©cup√©ration plong√©e:", error);
                    alert("Impossible de r√©cup√©rer les informations de la plong√©e.");
                }
            }
        </script>
        
        
        
        
        
                   
            
        
</body>
</html>

<style>
.palanquee-container {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    background-color: #1b263b;
    border-radius: 10px;
    padding: 20px;
    width: 90%;
    max-width: 600px;
    min-height: 140px;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.3);
    margin: 15px auto;
}

.palanquee-left {
    width: 50%;
    text-align: left;
}

.palanquee-right {
    width: 50%;
    text-align: right;
}

.palanquee-right label {
    display: block;
    font-size: 14px;
    color: white;
    margin-top: 5px;
}

.palanquee-right input {
    width: 80%;
    padding: 5px;
    margin-top: 3px;
    border-radius: 5px;
    border: none;
    font-size: 14px;
}

.btn-enregistrer {
    background-color: #28a745;
    color: white;
    padding: 8px 15px;
    border-radius: 5px;
    border: none;
    font-size: 16px;
    cursor: pointer;
    display: block;
    margin: 10px auto 0;
}

.btn-enregistrer:hover {
    background-color: #218838;
}
</style>

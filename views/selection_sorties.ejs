<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>S√©lection des Sorties</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FullCalendar -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js"></script>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen px-4">

    <div class="w-full max-w-md p-6">
        <!-- Titre -->
        <h1 class="text-3xl font-bold mb-4 text-center text-white">S√©lectionnez une Sortie</h1>

        <!-- Liste des sorties -->
        <div class="space-y-4">
            <% sorties.forEach(sortie => { %>
                <div class="bg-gray-800 p-4 rounded-lg shadow-md flex justify-between items-center cursor-pointer hover:bg-gray-700 transition duration-300" onclick="selectSortie('<%= sortie.id %>')">
                    <div class="flex items-center space-x-4 w-full">
                        <span class="font-bold text-lg truncate"><%= sortie.lieu %></span>
                        <span class="text-gray-400 text-sm whitespace-nowrap">
                            <%= new Date(sortie.date_debut).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' }) %>
                        </span>
                    </div>
                    <div class="w-6 h-6 rounded-full border-2 border-white flex items-center justify-center text-white opacity-50" id="checkmark-<%= sortie.id %>">
                        ‚úî
                    </div>
                </div>
            <% }) %>
        </div>
        

        <!-- Calendrier -->
        <div id="calendar" class="mt-6 bg-gray-800 p-4 rounded-lg shadow-md"></div>

        <input type="hidden" id="dateInput">

        <!-- Bouton Continuer -->
        <button id="continuer-btn" onclick="validerSelection()" class="mt-6 w-full bg-blue-500 hover:bg-blue-600 text-white text-lg font-semibold py-3 rounded-lg shadow-md transition duration-300">
            Continuer
        </button>
    </div>

    <!-- Bottom Navigation -->
    <div class="fixed bottom-0 left-0 w-full bg-gray-800 bg-opacity-80 backdrop-blur-md shadow-lg flex justify-around py-3 rounded-t-2xl">
        <a href="/" class="text-gray-400 hover:text-blue-400 flex flex-col items-center">
            <i class="fas fa-home text-xl"></i>
            <span class="text-xs">üè† Accueil</span>
        </a>
        <a href="/gestion-plongeurs" class="text-gray-400 hover:text-green-400 flex flex-col items-center">
            <i class="fas fa-users text-xl"></i>
            <span class="text-xs">üë§ Plongeurs</span>
        </a>
        <a href="/gestion-sorties" class="text-gray-400 hover:text-yellow-400 flex flex-col items-center">
            <i class="far fa-calendar-alt text-xl"></i>
            <span class="text-xs">ü§ø Sorties</span>
        </a>
        <a href="/selection-sorties" class="text-gray-400 hover:text-orange-400 flex flex-col items-center">
            <i class="fas fa-mask text-xl"></i>
            <span class="text-xs">üìã Palanqu√©es</span>
        </a>
    </div>

    <script>
        let selectedSortieId = null;
        let selectedDate = null;

        function selectSortie(sortieId) {
            selectedSortieId = sortieId;

            // R√©initialiser les checkmarks
            document.querySelectorAll('.w-6.h-6').forEach(el => el.classList.remove('opacity-100'));
            document.getElementById(`checkmark-${sortieId}`).classList.add('opacity-100');
        }

        function validerSelection() {
            const selectedDateValue = $('#dateInput').val();
            if (selectedSortieId && selectedDateValue) {
                window.location.href = `/plongees/${selectedSortieId}/${selectedDateValue}`;
            } else {
                alert("Veuillez s√©lectionner une sortie et une date.");
            }
        }

        $(document).ready(function() {
            const events = [];
            <% sorties.forEach(sortie => { %>
                events.push({
                    title: '<%= sortie.lieu %>',
                    start: '<%= sortie.date_debut %>',
                    end: '<%= sortie.date_fin %>',
                    allDay: true
                });
            <% }) %>

            $('#calendar').fullCalendar({
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'month,agendaWeek,agendaDay'
                },
                events: events,
                dayClick: function(date) {
                    if (selectedDate && selectedDate.isSame(date, 'day')) {
                        $('#calendar').fullCalendar('removeEvents', event => event.start.isSame(selectedDate, 'day'));
                        selectedDate = null;
                        $('#dateInput').val('');
                    } else {
                        if (selectedDate) {
                            $('#calendar').fullCalendar('removeEvents', event => event.start.isSame(selectedDate, 'day'));
                        }
                        selectedDate = date;
                        $('#calendar').fullCalendar('renderEvent', {
                            title: '',
                            start: date,
                            allDay: true,
                            className: ['selected-date']
                        }, true);
                        $('#dateInput').val(date.format('YYYY-MM-DD'));
                    }
                },
                editable: true,
                eventLimit: true,
            });
        });
    </script>
    <!-- IndexedDB and App Scripts -->
    <script src="/js/indexeddb.js"></script>
    <script src="/js/client.js"></script>
</body>
</html>
